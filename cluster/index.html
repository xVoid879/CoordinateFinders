<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Leaderboard</title>
<style>
  body { font-family: Arial, sans-serif; padding: 1rem; }
  #loading { font-weight: bold; }
  #leaderboard { margin-top: 1rem; }
</style>
</head>
<body>
  <h1>cluster leaderboard</h1>
  <div id="loading">Running...</div>
  <div id="leaderboard"></div>

<script>
  async function fetchLeaderboard() {
    const loadingDiv = document.getElementById('loading');
    const leaderboardDiv = document.getElementById('leaderboard');

    loadingDiv.style.display = 'block';
    leaderboardDiv.innerHTML = '';

    try {
      const assignmentsResponse = await fetch('https://clusterizer.mcathome.dev/assignments');
      if (!assignmentsResponse.ok) throw new Error('Failed to load assignments');
      const assignments = await assignmentsResponse.json();

      const leaderboard = {};
      assignments.forEach(a => {
        if (a.state === 'Submitted') {
          leaderboard[a.user_id] = (leaderboard[a.user_id] || 0) + 1;
        }
      });

      const users = {};
      const userIds = Object.keys(leaderboard);

      await Promise.all(userIds.map(async userId => {
        const userResp = await fetch(`https://clusterizer.mcathome.dev/users/${userId}`);
        if (userResp.ok) {
          const userJson = await userResp.json();
          users[userId] = userJson.name;
        } else {
          users[userId] = `User ${userId}`;
        }
      }));

      const sortedUsers = userIds.sort((a, b) => leaderboard[b] - leaderboard[a]);

      let html = '<ol>';
      for (const userId of sortedUsers) {
        html += `<li>${users[userId]} â€” ${leaderboard[userId]}</li>`;
      }
      html += '</ol>';

      leaderboardDiv.innerHTML = html;
    } catch (e) {
      leaderboardDiv.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
    } finally {
      loadingDiv.style.display = 'none';
    }
  }

  window.addEventListener('load', fetchLeaderboard);
</script>
</body>
</html>
